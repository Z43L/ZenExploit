#include "../include/plugin_manager.h"
#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h> // Para dlopen, dlsym

#define MAX_PLUGINS 10
static t_plugin* plugins[MAX_PLUGINS];
static int plugin_count = 0;

// Función para cargar un plugin
int load_plugin(const char* plugin_path) {
    if (plugin_count >= MAX_PLUGINS) {
        printf("Error: se ha alcanzado el máximo número de plugins.\n");
        return -1;
    }

    void* handle = dlopen(plugin_path, RTLD_LAZY);
    if (!handle) {
        fprintf(stderr, "%s\n", dlerror());
        return -1;
    }

    // Asigna memoria para el plugin
    t_plugin* plugin = (t_plugin*)dlsym(handle, "plugin");
    if (plugin == NULL) {
        fprintf(stderr, "%s\n", dlerror());
        dlclose(handle);
        return -1;
    }

    // Llama a las funciones de registro del plugin
    plugin->register_vectors();
    plugin->register_payloads();

    // Añade el plugin a la lista de plugins gestionados
    plugins[plugin_count++] = plugin;
    return 0;
}

// Función para inicializar todos los plugins
void initialize_plugins() {
    // Aquí podrías cargar plugins de un directorio o configuración específica
}
